<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>แก้ไขคำขอลา</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f9f9f9;
    }
    .container {
      max-width: 600px;
      margin: 40px auto;
    }
    .card-header {
      background-color: #6610f2;
      color: #fff;
      text-align: center;
    }
    .btn-primary, .btn-secondary {
      width: 100%;
    }
    .info-text {
      font-size: 0.9em;
      color: #6c757d;
      margin-top: 8px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="card shadow">
    <div class="card-header">
      <h4 class="m-0">แก้ไขคำขอลา</h4>
    </div>
    <div class="card-body">
      <form method="POST" onsubmit="return validateLeaveForm()">
        <!-- ประเภทการลา -->
        <div class="mb-3">
          <label for="leave_type" class="form-label">ประเภทการลา:</label>
          <select id="leave_type" name="leave_type" class="form-select" required onchange="toggleDateValidation()">
            <option value="vacation" {% if leave.leave_type == 'vacation' %}selected{% endif %}>ลาพักร้อน</option>
            <option value="personal" {% if leave.leave_type == 'personal' %}selected{% endif %}>ลากิจ</option>
            <option value="sick" {% if leave.leave_type == 'sick' %}selected{% endif %}>ลาป่วย</option>
            <option value="unpaid" {% if leave.leave_type == 'unpaid' %}selected{% endif %}>ลาหักเงิน</option>
            <option value="urgent" {% if leave.leave_type == 'urgent' %}selected{% endif %}>ลาฉุกเฉิน</option>
            <option value="funeral_no_deduction" {% if leave.leave_type == 'funeral_no_deduction' %}selected{% endif %}>ลางานศพ (ไม่หักเงิน)</option>
            <option value="funeral_with_deduction" {% if leave.leave_type == 'funeral_with_deduction' %}selected{% endif %}>ลางานศพ (หักเงิน)</option>
          </select>
        </div>

        <!-- วันเริ่มต้น -->
        <div class="mb-3">
          <label for="start_date" class="form-label">วันเริ่มต้นลา:</label>
          <input type="date" id="start_date" name="start_date" class="form-control" value="{{ leave.start_date }}" required>
        </div>

        <!-- วันสิ้นสุด -->
        <div class="mb-3">
          <label for="end_date" class="form-label">วันสิ้นสุดลา:</label>
          <input type="date" id="end_date" name="end_date" class="form-control" value="{{ leave.end_date }}" required>
        </div>

        <!-- เหตุผลการลา -->
        <div class="mb-3">
          <label for="reason" class="form-label">เหตุผลการลา:</label>
          <textarea id="reason" name="reason" class="form-control" rows="4" required>{{ leave.reason }}</textarea>
        </div>

        <!-- ปุ่มบันทึก -->
        <button type="submit" class="btn btn-primary mb-3">บันทึกการแก้ไข</button>
      </form>

      <!-- ปุ่มกลับ -->
      <a href="/my_leave_requests" class="btn btn-secondary">กลับ</a>
    </div>
  </div>
</div>

<script>
  // ตรวจสอบวันเริ่มต้นและวันสิ้นสุด
  function validateLeaveForm() {
    const startDate = document.getElementById("start_date").value;
    const endDate = document.getElementById("end_date").value;
    const leaveType = document.getElementById("leave_type").value;

    if (!startDate || !endDate) {
      alert("กรุณากรอกข้อมูลทุกช่อง");
      return false;
    }

    if (new Date(startDate) > new Date(endDate)) {
      alert("วันสิ้นสุดต้องไม่น้อยกว่าวันเริ่มต้น");
      return false;
    }

    const today = new Date();
    const pastLimit = new Date(today);
    pastLimit.setDate(today.getDate() - 7);

    // เงื่อนไขสำหรับประเภทการลาที่สามารถย้อนหลังได้
    const allowPastLeaveTypes = [
      "sick", 
      "unpaid", 
      "urgent", 
      "funeral_no_deduction", 
      "funeral_with_deduction"
    ];

    if (allowPastLeaveTypes.includes(leaveType)) {
      if (new Date(startDate) < pastLimit) {
        alert("วันเริ่มต้นลาย้อนหลังได้ไม่เกิน 7 วัน");
        return false;
      }
    } else {
      if (new Date(startDate) < today.setHours(0, 0, 0, 0)) {
        alert("วันเริ่มต้นต้องไม่น้อยกว่าวันปัจจุบัน");
        return false;
      }
    }

    return true;
  }

  // อัปเดตการตรวจสอบวันย้อนหลังเมื่อเปลี่ยนประเภทการลา
  function toggleDateValidation() {
    validateLeaveForm();
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
